<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Pixels Dojo Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/admin.css">
    <style>
      #quill-editor .ql-editor {
        color: black !important;        /* force readable text */
        background: #f8f9fa !important; /* light gray instead of pure white */
        min-height: 450px;
      }
      #quill-editor .ql-toolbar {
        background: #eee;
        border-bottom: 1px solid #ccc;
      }
    </style>

    <style>
      .modal-content {
        max-height: 85vh !important;
        overflow-y: auto !important;
        position: relative;
        padding: 2rem 2rem 6rem; /* extra bottom padding so close button stays visible */
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        overflow: auto; /* allow modal itself to scroll if needed */
      }

      .close {
        position: sticky;
        top: 1rem;
        float: right;
        font-size: 2.5rem;
        font-weight: bold;
        color: var(--yellow);
        cursor: pointer;
        z-index: 10;
        background: rgba(0,0,0,0.5);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        line-height: 40px;
        text-align: center;
      }

      .close:hover {
        color: white;
        background: var(--cyan);
      }
    </style>
</head>
<body>
    <%- include('partials/header') %>

    <nav>
      <ul>
        <li><a href="/">Home</a></li>
        <li><a href="/category/startup">Start Here</a></li>
        <li><a href="/category/earn">Earn $PIXEL</a></li>
        <li><a href="/category/mastery">Mastery</a></li>
        <li><a href="/npcs">NPCs</a></li>
        <li><a href="/category/community">Community</a></li>
      </ul>
    </nav>

    <div class="admin-container">
        <h1>üõ†Ô∏è Admin Dashboard</h1>

        <!-- Admin Tools Navigation -->
        <% if (user && user.is_admin) { %>
          <div class="admin-tools-nav" style="margin: 1rem 0; padding: 0.8rem; background: rgba(0,255,255,0.08); border-radius: 8px; border: 1px solid rgba(0,255,255,0.2);">
            <a href="/admin/analytics" class="btn btn-secondary" style="margin-right: 1rem; padding: 0.6rem 1.2rem;">
              üìä View Site Analytics
            </a>
            <a href="/admin/users" class="btn btn-secondary" style="margin-right: 1rem; padding: 0.6rem 1.2rem;">
              üë• Manage Users & Invite Contributors
            </a>
            <!-- You can add more admin tool links here later -->
          </div>
        <% } %>

        <!-- Wiki Pages Management Section -->
        <section style="margin-top: 2rem;">
            <h2>Wiki Pages Management</h2>
            <div class="admin-actions">
                <button onclick="showAddPageModal()" class="btn-primary">‚ûï Add New Page</button>
            </div>

            <div class="page-table">
                <table>
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Slug</th>
                            <th>Category</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (pages && pages.length > 0) { %>
                            <% pages.forEach(page => { %>
                                <tr>
                                    <td><%= page.title %></td>
                                    <td><%= page.slug %></td>
                                    <td><%= page.category || '‚Äî' %></td>
                                    <td><%= new Date(page.created_at).toLocaleDateString() %></td>
                                    <td class="actions">
                                    <button onclick="window.open('/pages/<%= page.slug %>', '_blank')" class="btn-action btn-view">üëÅÔ∏è View</button>
                                    <button onclick="editPage(<%= page.id %>, '<%= page.title.replace(/'/g, "\\'") %>')" class="btn-action btn-edit">‚úèÔ∏è Edit</button>
                                    <button onclick="deletePage(<%= page.id %>, '<%= page.title.replace(/'/g, "\\'") %>')" class="btn-action btn-delete">üóëÔ∏è Delete</button>
                                </td>
                                </tr>
                            <% }); %>
                        <% } else { %>
                            <tr><td colspan="5">No pages yet ‚Äî add one above!</td></tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- NPC Management Section -->
        <section>
            <h2>NPC Management</h2>
            <div class="admin-actions">
                <button onclick="showAddModal('addNpcModal')" class="btn-primary">Add New NPC</button>
            </div>

            <div class="npc-grid">
                <% npcs.forEach(npc => { %>
                    <div class="npc-card">
                        <div class="npc-left">
                            <img src="<%= npc.image_path %>" alt="<%= npc.name %>" 
                                 class="npc-thumb" style="max-width:160px; height:auto; object-fit:contain;"
                                 onerror="this.src='/images/npcs/default-npc.png'">
                            <div>
                                <strong><%= npc.name %></strong><br>
                                <small><%= npc.location || '‚Äî' %></small>
                            </div>
                        </div>
                        <div class="npc-right">
                            <p><%= npc.description ? npc.description.substring(0, 100) + '...' : 'No description' %></p>
                            <small>Order: <%= npc.display_order %></small>
                            <div class="actions">
                                <button onclick="editNPC(<%= npc.id %>, '<%= npc.name.replace(/'/g, "\\'") %>', '<%= npc.location ? npc.location.replace(/'/g, "\\'") : '' %>', '<%= (npc.description || '').replace(/'/g, "\\'") %>', <%= npc.display_order %>, '<%= npc.image_path.replace(/'/g, "\\'") %>')" class="btn-edit">‚úèÔ∏è Edit</button>
                                <button onclick="deleteNPC(<%= npc.id %>, '<%= npc.name.replace(/'/g, "\\'") %>')" class="btn-delete">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                    </div>
                <% }); %>
            </div>
        </section>
    </div>

    <!-- Edit NPC Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editModal')">√ó</span>
            <h2>Edit NPC</h2>
            <form id="editForm" method="POST" enctype="multipart/form-data">
                <input type="hidden" id="edit_id" name="id">
                <input type="hidden" id="edit_current_image_path" name="current_image_path">
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="edit_name" name="name" required>
                </div>
                <div class="form-group">
                    <label>Location *</label>
                    <input type="text" id="edit_location" name="location" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="edit_description" name="description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Image (leave empty to keep current)</label>
                    <input type="file" name="image" accept="image/*">
                    <small>Any size/shape OK (portrait 160√ó200 works great).</small>
                </div>
                <div class="form-group">
                    <label>Display Order</label>
                    <input type="number" id="edit_display_order" name="display_order">
                </div>
                <button type="submit" class="btn-primary">Update NPC</button>
            </form>
        </div>
    </div>

<!-- Edit Page Modal ‚Äì Bootstrap style -->
<div class="modal fade" id="editPageModal" tabindex="-1" aria-labelledby="editPageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl"> <!-- extra large for Quill -->
    <div class="modal-content">
        <span class="close" onclick="closeModal('editPageModal')">√ó</span>
      <div class="modal-header">
      <h5 class="modal-title" id="editPageModalLabel">Edit Wiki Page</h5>
       
      </div>
      <div class="modal-body">
        <form id="editPageForm" method="POST" action="/admin/pages/:id/update" enctype="multipart/form-data">
          <input type="hidden" name="_method" value="PUT"> <!-- if using method-override -->
          <input type="hidden" name="id" id="editPageId">

          <div class="mb-3">
            <label for="editTitle" class="form-label">Title *</label>
            <input type="text" class="form-control" id="editTitle" name="title" required>
          </div>

          <div class="mb-3">
            <label for="editSlug" class="form-label">Slug (cannot be changed)</label>
            <input 
              type="text" 
              class="form-control bg-light" 
              id="editSlug" 
              name="slug" 
              readonly
              style="cursor: not-allowed;"
            >
          </div>

         <div class="mb-3">
          <label>Category *</label>
  <select name="category" required style="width:100%; padding:0.8rem;">
    <option value="">Select category</option>
    <option value="startup">Start Here</option>
    <option value="earn">Earn $PIXEL</option>
    <option value="mastery">Mastery</option>
    <option value="general">General / Other</option>
  </select>
</div>

          <div class="mb-3">
            <label for="editDifficulty" class="form-label">Difficulty</label>
            <select class="form-control" id="editDifficulty" name="difficulty">
              <option value="Beginner">Beginner</option>
              <option value="Intermediate">Intermediate</option>
              <option value="Advanced">Advanced</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="editSummary" class="form-label">Quick Summary</label>
            <textarea class="form-control" id="editSummary" name="summary" rows="3"></textarea>
          </div>

          <div class="mb-3">
            <label for="editProTips" class="form-label">Pro Tips / Hacks</label>
            <textarea class="form-control" id="editProTips" name="pro_tips" rows="5"></textarea>
          </div>

          <div class="mb-3">
            <label for="editScreenshots" class="form-label">Add New Screenshots</label>
            <input type="file" class="form-control" id="editScreenshots" name="screenshots" multiple accept="image/*">
            <small>Existing screenshots will stay unless replaced.</small>
          </div>

          <div class="mb-3">
            <label class="form-label">Main Content</label>
            <div id="editQuillEditor" style="height: 450px; background: white;"></div>
            <textarea name="content" id="editContent" style="display: none;"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="submit" form="editPageForm" class="btn btn-primary">Save Changes</button>
      </div>
    </div>
  </div>
</div>

    <!-- Add Page Modal -->
    <div id="addPageModal" class="modal">
        <div class="modal-content" style="max-height: 85vh; overflow-y: auto; padding-bottom: 2rem;">
            <span class="close" onclick="closeModal('addPageModal')">√ó</span>
            <h2>Add New Wiki Page</h2>
            <form id="addPageForm" method="POST" action="/admin/pages" enctype="multipart/form-data">
                <div class="form-group">
                    <label>Title *</label>
                    <input type="text" name="title" required placeholder="e.g. Farming Guide">
                </div>

                <div class="form-group">
                    <label>Slug (URL-friendly) *</label>
                    <input type="text" name="slug" required placeholder="e.g. farming-guide">
                </div>

               <div class="form-group">
  <label>Category *</label>
  <select name="category" required style="width:100%; padding:0.8rem;">
    <option value="">Select category</option>
    <option value="startup">Start Here</option>
    <option value="earn">Earn $PIXEL</option>
    <option value="mastery">Mastery</option>
    <option value="general">General / Other</option>
  </select>
</div>

                <div class="form-group">
                    <label>Difficulty Level *</label>
                    <select name="difficulty" required style="width:100%; padding:0.8rem;">
                        <option value="Beginner">Beginner</option>
                        <option value="Intermediate">Intermediate</option>
                        <option value="Advanced">Advanced</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Quick Summary (2-3 sentences TL;DR)</label>
                    <textarea name="summary" rows="3" placeholder="Quick overview of the guide..."></textarea>
                </div>

                <div class="form-group">
                    <label>Pro Tips / Hacks</label>
                    <textarea name="pro_tips" rows="5" placeholder="Advanced tricks, shortcuts, player discoveries..."></textarea>
                </div>

                <div class="form-group">
                    <label>Screenshots (up to 15 ‚Äì any aspect ratio OK)</label>
                    <input type="file" name="screenshots" accept="image/*" multiple>
                    <small>Max 350√ó350 recommended per image, but any size is fine. Will be resized/displayed responsively.</small>
                </div>

                <div class="form-group">
                    <label>Main Content (paste from Word here)</label>
                    <div id="quill-editor" style="height: 450px; background: white;"></div>
                    <textarea name="content" id="content-hidden" style="display: none;"></textarea>
                </div>

                <button type="submit" class="btn-primary" style="width:100%; margin-top:1rem;">Create Page</button>
            </form>
        </div>
    </div>

    <!-- Add NPC Modal -->
    <div id="addNpcModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addNpcModal')">√ó</span>
            <h2>Add New NPC</h2>
            <form id="addNpcForm" method="POST" action="/admin/npcs" enctype="multipart/form-data">
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" name="name" required>
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" name="location">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Image</label>
                    <input type="file" name="image" accept="image/*">
                </div>
                <div class="form-group">
                    <label>Display Order</label>
                    <input type="number" name="display_order" value="999">
                </div>
                <button type="submit" class="btn-primary">Add NPC</button>
            </form>
        </div>
    </div>

        <!-- Scripts -->
    <!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>

<script>
    let quill = null;       // for add modal
    let editQuill = null;   // for edit modal

    // ‚îÄ‚îÄ‚îÄ Add Page Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showAddPageModal() {
        const modal = document.getElementById('addPageModal');
        if (!modal) return console.error('Add modal not found');

        modal.style.display = 'block';

        if (!quill) {
            quill = new Quill('#quill-editor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['link', 'image'],
                        ['clean']
                    ],
                    clipboard: {
                        matchers: [
                            [Node.ELEMENT_NODE, (node, delta) => {
                                if (node.tagName === 'IMG') {
                                    return new Delta().insert({ image: node.src });
                                }
                                return delta;
                            }]
                        ],
                        matchVisual: false
                    }
                },
                placeholder: 'Paste your Word content here (steps + images should come along)...'
            });
        }
    }

    // Save Quill content when submitting add form
    document.addEventListener('DOMContentLoaded', () => {
        const addForm = document.getElementById('addPageForm');
        if (addForm) {
            addForm.addEventListener('submit', function(e) {
                if (quill) {
                    document.getElementById('content-hidden').value = quill.root.innerHTML;
                    console.log('Saving Quill content (add):', quill.root.innerHTML);
                } else {
                    console.warn('Quill not initialized on add form submit');
                }
            });
        }
    });

    // ‚îÄ‚îÄ‚îÄ Generic modal helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showAddModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.style.display = 'block';
    }

    function closeModal(id) {
        const modal = document.getElementById(id);
        if (modal) modal.style.display = 'none';
    }

    // ‚îÄ‚îÄ‚îÄ Edit NPC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function editNPC(id, name, location, description, display_order, currentImagePath) {
        document.getElementById('edit_id').value = id;
        document.getElementById('edit_name').value = name;
        document.getElementById('edit_location').value = location || '';
        document.getElementById('edit_description').value = description || '';
        document.getElementById('edit_display_order').value = display_order;
        document.getElementById('edit_current_image_path').value = currentImagePath || '/images/npcs/default-npc.png';

        document.getElementById('editForm').action = '/admin/npcs/' + id;
        document.getElementById('editModal').style.display = 'block';
    }

    // ‚îÄ‚îÄ‚îÄ Edit Wiki Page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function editPage(id, title) {
        fetch(`/admin/pages/${id}/edit`)
            .then(res => {
                if (!res.ok) throw new Error(`HTTP ${res.status}: Failed to load page`);
                return res.json();
            })
            .then(page => {
                // Fill form fields (using correct IDs from your HTML)
                const idEl    = document.getElementById('editPageId');
                const titleEl = document.getElementById('editTitle');
                const slugEl  = document.getElementById('editSlug');

                if (idEl)    idEl.value    = page.id;
                if (titleEl) titleEl.value = page.title || '';
                if (slugEl)  slugEl.value  = page.slug || '';

                // Show modal
                const modal = document.getElementById('editPageModal');
                if (modal) modal.style.display = 'block';

                // Initialize Quill for edit (once)
                if (!editQuill) {
                    editQuill = new Quill('#editQuillEditor', {
                        theme: 'snow',
                        modules: {
                            toolbar: [
                                [{ 'header': [1, 2, 3, false] }],
                                ['bold', 'italic', 'underline', 'strike'],
                                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                                ['link', 'image'],
                                ['clean']
                            ],
                            clipboard: { matchVisual: false }
                        },
                        placeholder: 'Edit content here...'
                    });
                }

                // Load content safely
                try {
                    const delta = JSON.parse(page.content || '[]');
                    editQuill.setContents(delta);
                } catch (e) {
                    console.warn('Content not valid Delta ‚Äì using HTML fallback');
                    editQuill.root.innerHTML = page.content || '';
                }

                // Handle form submit via AJAX
                const editForm = document.getElementById('editPageForm');
                if (editForm) {
                    editForm.onsubmit = function(e) {
                        e.preventDefault();

                        // Save Quill content to hidden field
                        document.getElementById('editContent').value = editQuill.root.innerHTML;

                        const formData = new FormData(editForm);

                        fetch(`/admin/pages/${page.id}/update`, {
                            method: 'POST',
                            body: formData
                        })
                        .then(r => r.json())
                        .then(data => {
                            if (data.success) {
                                alert('Page updated successfully!');
                                modal.style.display = 'none';
                                location.reload(); // refresh admin list
                            } else {
                                alert('Save failed: ' + (data.error || 'Unknown error'));
                            }
                        })
                        .catch(err => {
                            console.error('Save error:', err);
                            alert('Error saving page: ' + err.message);
                        });
                    };
                }
            })
            .catch(err => {
                console.error('Edit page fetch error:', err);
                alert('Error loading page: ' + err.message);
            });
    }

    // ‚îÄ‚îÄ‚îÄ Delete NPC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function deleteNPC(id, name) {
        if (!confirm(`Are you sure you want to delete "${name}"?`)) return;

        fetch(`/admin/npcs/${id}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => {
            if (response.ok) {
                alert('NPC deleted!');
                location.reload();
            } else {
                return response.json().then(err => {
                    alert('Unable to delete: ' + (err.error || 'Unknown error'));
                });
            }
        })
        .catch(err => alert('Error: ' + err));
    }

    // ‚îÄ‚îÄ‚îÄ Delete Page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function deletePage(id, title) {
        if (!confirm(`Are you sure you want to delete "${title}"?`)) return;

        fetch(`/admin/pages/${id}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => {
            if (response.ok) {
                alert('Page deleted!');
                location.reload();
            } else {
                return response.json().then(err => {
                    alert('Unable to delete: ' + (err.error || 'Server error'));
                });
            }
        })
        .catch(err => alert('Error: ' + err));
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
    <script>
<script src="/js/admin.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
