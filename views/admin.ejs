<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Pixels Dojo Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/admin.css">
    <style>
      #quill-editor .ql-editor {
        color: black !important;        /* force readable text */
        background: #f8f9fa !important; /* light gray instead of pure white */
        min-height: 450px;
      }
      #quill-editor .ql-toolbar {
        background: #eee;
        border-bottom: 1px solid #ccc;
      }
    </style>

    <style>
      .modal-content {
        max-height: 85vh !important;
        overflow-y: auto !important;
        position: relative;
        padding: 2rem 2rem 6rem; /* extra bottom padding so close button stays visible */
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        overflow: auto; /* allow modal itself to scroll if needed */
      }

      .close {
        position: sticky;
        top: 1rem;
        float: right;
        font-size: 2.5rem;
        font-weight: bold;
        color: var(--yellow);
        cursor: pointer;
        z-index: 10;
        background: rgba(0,0,0,0.5);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        line-height: 40px;
        text-align: center;
      }

      .close:hover {
        color: white;
        background: var(--cyan);
      }

      /* Event-specific fields styling */
      #eventFields {
        background: rgba(0, 255, 255, 0.05);
        padding: 1.5rem;
        border-radius: 8px;
        border: 1px solid rgba(0, 255, 255, 0.2);
        margin-top: 1rem;
      }

      #eventFields label {
        color: var(--cyan);
        font-weight: 500;
      }
    </style>
</head>
<body>
    <%- include('partials/header') %>

    <nav>
      <ul>
        <li><a href="/">Home</a></li>
        <li><a href="/category/startup">Start Here</a></li>
        <li><a href="/category/earn">Earn $PIXEL</a></li>
        <li><a href="/category/mastery">Mastery</a></li>
        <li><a href="/npcs-map">NPCs & Map</a></li>
        <li><a href="/events">Events</a></li>
        <li><a href="/amas">AMAs</a></li>
        <li><a href="/category/community">Community</a></li>
      </ul>
    </nav>

    <div class="admin-container">
        <h1>üõ†Ô∏è Admin Dashboard</h1>

        <!-- Admin Tools Navigation -->
        <% if (user && user.is_admin) { %>
          <div class="admin-tools-nav" style="margin: 1rem 0; padding: 0.8rem; background: rgba(0,255,255,0.08); border-radius: 8px; border: 1px solid rgba(0,255,255,0.2);">
            <a href="/admin/analytics" class="btn btn-secondary" style="margin-right: 1rem; padding: 0.6rem 1.2rem;">
              üìä View Site Analytics
            </a>
            <a href="/admin/users" class="btn btn-secondary" style="margin-right: 1rem; padding: 0.6rem 1.2rem;">
              üë• Manage Users & Invite Contributors
            </a>
            <!-- You can add more admin tool links here later -->
          </div>
        <% } %>

        <!-- TABBED ADMIN SECTIONS -->
        <div style="margin-top: 2rem;">

          <!-- Tab Buttons -->
          <div style="display:flex; gap:4px; border-bottom:2px solid rgba(0,255,255,0.3); margin-bottom:1.5rem;">
            <button id="tab-btn-pages" onclick="switchTab('pages')"
              style="padding:0.8rem 2rem; background:var(--cyan); color:#000; border:none; border-radius:8px 8px 0 0; font-weight:bold; cursor:pointer; font-size:1rem;">
              üìÑ Pages
            </button>
            <button id="tab-btn-npcs" onclick="switchTab('npcs')"
              style="padding:0.8rem 2rem; background:rgba(0,255,255,0.1); color:var(--cyan); border:none; border-radius:8px 8px 0 0; font-weight:bold; cursor:pointer; font-size:1rem;">
              üé≠ NPCs
            </button>
          </div>

          <!-- PAGES TAB -->
          <div id="tabcontent-pages">
            <div class="admin-actions" style="margin-bottom:1rem;">
              <button onclick="showAddPageModal()" class="btn-primary">‚ûï Add New Page</button>
            </div>
            <div style="margin-bottom:1rem;">
              <input type="text" id="pageSearch" placeholder="üîç Search by title or category..."
                oninput="filterPages()"
                style="width:100%; max-width:500px; padding:0.8rem 1rem; background:rgba(0,0,0,0.3); border:1px solid rgba(0,255,255,0.3); border-radius:8px; color:white; font-size:1rem;">
            </div>
            <div class="page-table">
              <table>
                <thead>
                  <tr><th>Title</th><th>Category</th><th>Status</th><th>Created</th><th>Actions</th></tr>
                </thead>
                <tbody id="pagesTableBody">
                  <% if (pages && pages.length > 0) { %>
                    <% pages.forEach(page => { %>
                      <tr data-title="<%= (page.title||'').toLowerCase() %>" data-category="<%= (page.category||'').toLowerCase() %>">
                        <td><%= page.title %></td>
                        <td><%= page.category || '‚Äî' %></td>
                        <td>
                          <span style="padding:0.2rem 0.6rem; border-radius:4px; font-size:0.8rem; font-weight:bold; background:<%= page.status==='draft' ? 'rgba(255,200,0,0.2)' : 'rgba(65,225,20,0.2)' %>; color:<%= page.status==='draft' ? '#ffc800' : '#41e114' %>;">
                            <%= page.status==='draft' ? 'üìù Draft' : '‚úÖ Published' %>
                          </span>
                        </td>
                        <td><%= new Date(page.created_at).toLocaleDateString() %></td>
                        <td class="actions">
                          <button onclick="window.open('/pages/<%= page.slug %>','_blank')" class="btn-action btn-view">üëÅÔ∏è View</button>
                          <button onclick="editPage(<%= page.id %>, '<%= page.title.replace(/'/g, \"\\\'\") %>')" class="btn-action btn-edit">‚úèÔ∏è Edit</button>
                          <button onclick="deletePage(<%= page.id %>, '<%= page.title.replace(/'/g, \"\\\'\") %>')" class="btn-action btn-delete">üóëÔ∏è Delete</button>
                        </td>
                      </tr>
                    <% }); %>
                  <% } else { %>
                    <tr><td colspan="5">No pages yet ‚Äî add one above!</td></tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>

          <!-- NPCS TAB -->
          <div id="tabcontent-npcs" style="display:none;">
            <div class="admin-actions" style="margin-bottom:1rem;">
              <button onclick="showAddModal('addNpcModal')" class="btn-primary">Add New NPC</button>
            </div>
            <!-- Search Bar -->
            <div style="margin: 1.5rem 0;">
                <input type="text" id="npcSearch" placeholder="üîç Search NPCs by name or location..."
                    style="width: 100%; max-width: 500px; padding: 0.8rem 1rem; background: rgba(0,0,0,0.3); border: 1px solid rgba(0,255,255,0.3); border-radius: 8px; color: white; font-size: 1rem;"
                    onkeyup="filterNPCs()">
            </div>
        </div> <!-- end tabs container -->
    </div>

    <!-- Edit NPC Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editModal')">√ó</span>
            <h2>Edit NPC</h2>
            <form id="editForm" method="POST" enctype="multipart/form-data">
                <input type="hidden" id="edit_id" name="id">
                <input type="hidden" id="edit_current_image_path" name="current_image_path">
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="edit_name" name="name" required>
                </div>
                <div class="form-group">
                    <label>Location *</label>
                    <input type="text" id="edit_location" name="location" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="edit_description" name="description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Image (leave empty to keep current)</label>
                    <input type="file" name="image" accept="image/*">
                    <small>Any size/shape OK (portrait 160√ó200 works great).</small>
                </div>
                <div class="form-group">
                    <label>Display Order</label>
                    <input type="number" id="edit_display_order" name="display_order">
                </div>
                <button type="submit" class="btn-primary">Update NPC</button>
            </form>
        </div>
    </div>

<!-- Edit Page Modal ‚Äì Bootstrap style -->
<div class="modal fade" id="editPageModal" tabindex="-1" aria-labelledby="editPageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl"> <!-- extra large for Quill -->
    <div class="modal-content">
        <span class="close" onclick="closeModal('editPageModal')">√ó</span>
      <div class="modal-header">
      <h5 class="modal-title" id="editPageModalLabel">Edit Wiki Page</h5>
       
      </div>
      <div class="modal-body">
        <form id="editPageForm" method="POST" action="/admin/pages/:id/update" enctype="multipart/form-data">
          <input type="hidden" name="_method" value="PUT"> <!-- if using method-override -->
          <input type="hidden" name="id" id="editPageId">

          <div class="mb-3">
            <label for="editTitle" class="form-label">Title *</label>
            <input type="text" class="form-control" id="editTitle" name="title" required>
          </div>

          <div class="mb-3">
            <label for="editSlug" class="form-label">Slug (cannot be changed)</label>
            <input 
              type="text" 
              class="form-control bg-light" 
              id="editSlug" 
              name="slug" 
              readonly
              style="cursor: not-allowed;"
            >
          </div>

         <div class="mb-3">
          <label>Category *</label>
  <select name="category" id="editCategory" required style="width:100%; padding:0.8rem;" onchange="toggleEventFields('edit')">
    <option value="">Select category</option>
    <option value="startup">Start Here</option>
    <option value="earn">Earn $PIXEL</option>
    <option value="mastery">Mastery</option>
    <option value="events">Events</option>
    <option value="general">General / Other</option>
  </select>
</div>

          <!-- Event-specific fields for EDIT modal -->
          <div id="editEventFields" style="display: none;">
            <div class="mb-3">
              <label for="editEventExpiry" class="form-label">Event Expiry Date & Time *</label>
              <input type="datetime-local" class="form-control" id="editEventExpiry" name="event_expiry">
              <small style="color: #999;">Set when this event should expire and be removed from the Events page</small>
            </div>
            <div class="mb-3">
              <label for="editEventLocation" class="form-label">Event Location (optional)</label>
              <input type="text" class="form-control" id="editEventLocation" name="event_location" placeholder="e.g., Discord, Community Hall, etc.">
            </div>
          </div>

          <div class="mb-3">
            <label for="editDifficulty" class="form-label">Difficulty</label>
            <select class="form-control" id="editDifficulty" name="difficulty">
              <option value="Beginner">Beginner</option>
              <option value="Intermediate">Intermediate</option>
              <option value="Advanced">Advanced</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="editSummary" class="form-label">Quick Summary</label>
            <textarea class="form-control" id="editSummary" name="summary" rows="3"></textarea>
          </div>

          <div class="mb-3">
            <label for="editProTips" class="form-label">Pro Tips / Hacks</label>
            <textarea class="form-control" id="editProTips" name="pro_tips" rows="5"></textarea>
          </div>

          <div class="mb-3">
            <label for="editScreenshots" class="form-label">Add New Screenshots</label>
            <input type="file" class="form-control" id="editScreenshots" name="screenshots" multiple accept="image/*">
            <small>Existing screenshots will stay unless replaced.</small>
          </div>

          <div class="mb-3">
            <label class="form-label">Main Content</label>
            <div id="editQuillEditor" style="height: 450px; background: white;"></div>
            <textarea name="content" id="editContent" style="display: none;"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="submit" form="editPageForm" class="btn btn-primary">Save Changes</button>
      </div>
    </div>
  </div>
</div>

    <!-- Add Page Modal -->
    <div id="addPageModal" class="modal">
        <div class="modal-content" style="max-height: 85vh; overflow-y: auto; padding-bottom: 2rem;">
            <span class="close" onclick="closeModal('addPageModal')">√ó</span>
            <h2>Add New Wiki Page</h2>
            <form id="addPageForm" method="POST" action="/admin/pages" enctype="multipart/form-data">
                <div class="form-group">
                    <label>Title *</label>
                    <input type="text" name="title" required placeholder="e.g. Farming Guide">
                </div>

                <div class="form-group">
                    <label>Slug (URL-friendly) *</label>
                    <input type="text" name="slug" required placeholder="e.g. farming-guide">
                </div>

               <div class="form-group">
  <label>Category *</label>
  <select name="category" id="addCategory" required style="width:100%; padding:0.8rem;" onchange="toggleEventFields('add')">
    <option value="">Select category</option>
    <option value="startup">Start Here</option>
    <option value="earn">Earn $PIXEL</option>
    <option value="mastery">Mastery</option>
    <option value="events">Events</option>
    <option value="general">General / Other</option>
  </select>
</div>

                <!-- Event-specific fields for ADD modal -->
                <div id="eventFields" style="display: none;">
                  <div class="form-group">
                    <label>Event Expiry Date & Time *</label>
                    <input type="datetime-local" name="event_expiry" id="eventExpiry">
                    <small style="color: #999;">Set when this event should expire and be removed from the Events page</small>
                  </div>
                  <div class="form-group">
                    <label>Event Location (optional)</label>
                    <input type="text" name="event_location" id="eventLocation" placeholder="e.g., Discord, Community Hall, etc.">
                  </div>
                </div>

                <div class="form-group">
                    <label>Difficulty Level *</label>
                    <select name="difficulty" required style="width:100%; padding:0.8rem;">
                        <option value="Beginner">Beginner</option>
                        <option value="Intermediate">Intermediate</option>
                        <option value="Advanced">Advanced</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Quick Summary (2-3 sentences TL;DR)</label>
                    <textarea name="summary" rows="3" placeholder="Quick overview of the guide..."></textarea>
                </div>

                <div class="form-group">
                    <label>Pro Tips / Hacks</label>
                    <textarea name="pro_tips" rows="5" placeholder="Advanced tricks, shortcuts, player discoveries..."></textarea>
                </div>

                <div class="form-group">
                    <label>Screenshots (up to 15 ‚Äì any aspect ratio OK)</label>
                    <input type="file" name="screenshots" accept="image/*" multiple>
                    <small>Max 350√ó350 recommended per image, but any size is fine. Will be resized/displayed responsively.</small>
                </div>

                <div class="form-group">
                    <label>Main Content (paste from Word here)</label>
                    <div id="quill-editor" style="height: 450px; background: white;"></div>
                    <textarea name="content" id="content-hidden" style="display: none;"></textarea>
                </div>

                <button type="submit" class="btn-primary" style="width:100%; margin-top:1rem;">Create Page</button>
            </form>
        </div>
    </div>

    <!-- Add NPC Modal -->
    <div id="addNpcModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addNpcModal')">√ó</span>
            <h2>Add New NPC</h2>
            <form id="addNpcForm" method="POST" action="/admin/npcs" enctype="multipart/form-data">
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" name="name" required>
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" name="location">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Image</label>
                    <input type="file" name="image" accept="image/*">
                </div>
                <div class="form-group">
                    <label>Display Order</label>
                    <input type="number" name="display_order" value="999">
                </div>
                <button type="submit" class="btn-primary">Add NPC</button>
            </form>
        </div>
    </div>

        <!-- Scripts -->
    <!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>

<script>
    let quill = null;       // for add modal
    let editQuill = null;   // for edit modal

    // ‚îÄ‚îÄ‚îÄ Toggle Event Fields ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleEventFields(mode) {
        const categorySelect = mode === 'add' ? document.getElementById('addCategory') : document.getElementById('editCategory');
        const eventFields = mode === 'add' ? document.getElementById('eventFields') : document.getElementById('editEventFields');
        const expiryInput = mode === 'add' ? document.getElementById('eventExpiry') : document.getElementById('editEventExpiry');
        
        if (categorySelect.value === 'events') {
            eventFields.style.display = 'block';
            if (expiryInput) expiryInput.required = true;
        } else {
            eventFields.style.display = 'none';
            if (expiryInput) expiryInput.required = false;
        }
    }

    // ‚îÄ‚îÄ‚îÄ Add Page Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showAddPageModal() {
        const modal = document.getElementById('addPageModal');
        if (!modal) return console.error('Add modal not found');

        modal.style.display = 'block';

        if (!quill) {
            quill = new Quill('#quill-editor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['link', 'image'],
                        ['clean']
                    ],
                    clipboard: {
                        matchers: [
                            [Node.ELEMENT_NODE, (node, delta) => {
                                if (node.tagName === 'IMG') {
                                    return new Delta().insert({ image: node.src });
                                }
                                return delta;
                            }]
                        ],
                        matchVisual: false
                    }
                },
                placeholder: 'Paste your Word content here (steps + images should come along)...'
            });
        }
    }

    // Save Quill content when submitting add form
    document.addEventListener('DOMContentLoaded', () => {
        const addForm = document.getElementById('addPageForm');
        if (addForm) {
            addForm.addEventListener('submit', function(e) {
                if (quill) {
                    document.getElementById('content-hidden').value = quill.root.innerHTML;
                    console.log('Saving Quill content (add):', quill.root.innerHTML);
                } else {
                    console.warn('Quill not initialized on add form submit');
                }
            });
        }
    });

    // ‚îÄ‚îÄ‚îÄ Generic modal helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showAddModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.style.display = 'block';
    }

    function closeModal(id) {
        const modal = document.getElementById(id);
        if (modal) modal.style.display = 'none';
    }

    // ‚îÄ‚îÄ‚îÄ Edit NPC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function editNPC(id, name, location, description, display_order, currentImagePath) {
        document.getElementById('edit_id').value = id;
        document.getElementById('edit_name').value = name;
        document.getElementById('edit_location').value = location || '';
        document.getElementById('edit_description').value = description || '';
        document.getElementById('edit_display_order').value = display_order;
        document.getElementById('edit_current_image_path').value = currentImagePath || '/images/npcs/default-npc.png';

        document.getElementById('editForm').action = '/admin/npcs/' + id + '/update';
        document.getElementById('editModal').style.display = 'block';
    }

    // ‚îÄ‚îÄ‚îÄ Edit Wiki Page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function editPage(id, title) {
        fetch(`/admin/pages/${id}/edit`)
            .then(res => {
                if (!res.ok) throw new Error(`HTTP ${res.status}: Failed to load page`);
                return res.json();
            })
            .then(page => {
                // Fill form fields (using correct IDs from your HTML)
                const idEl    = document.getElementById('editPageId');
                const titleEl = document.getElementById('editTitle');
                const slugEl  = document.getElementById('editSlug');
                const categoryEl = document.getElementById('editCategory');
                const eventExpiryEl = document.getElementById('editEventExpiry');
                const eventLocationEl = document.getElementById('editEventLocation');

                if (idEl)    idEl.value    = page.id;
                if (titleEl) titleEl.value = page.title || '';
                if (slugEl)  slugEl.value  = page.slug || '';
                if (categoryEl) categoryEl.value = page.category || '';

                // Handle event-specific fields
                if (eventExpiryEl && page.event_expiry) {
                    eventExpiryEl.value = page.event_expiry;
                }
                if (eventLocationEl && page.event_location) {
                    eventLocationEl.value = page.event_location;
                }

                // Show/hide event fields based on category
                toggleEventFields('edit');

                // Show modal
                const modal = document.getElementById('editPageModal');
                if (modal) modal.style.display = 'block';

                // Initialize Quill for edit (once)
                if (!editQuill) {
                    editQuill = new Quill('#editQuillEditor', {
                        theme: 'snow',
                        modules: {
                            toolbar: [
                                [{ 'header': [1, 2, 3, false] }],
                                ['bold', 'italic', 'underline', 'strike'],
                                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                                ['link', 'image'],
                                ['clean']
                            ],
                            clipboard: { matchVisual: false }
                        },
                        placeholder: 'Edit content here...'
                    });
                }

                // Load content safely
                try {
                    const delta = JSON.parse(page.content || '[]');
                    editQuill.setContents(delta);
                } catch (e) {
                    console.warn('Content not valid Delta ‚Äì using HTML fallback');
                    editQuill.root.innerHTML = page.content || '';
                }

                // Handle form submit via AJAX
                const editForm = document.getElementById('editPageForm');
                if (editForm) {
                    editForm.onsubmit = function(e) {
                        e.preventDefault();

                        // Save Quill content to hidden field
                        document.getElementById('editContent').value = editQuill.root.innerHTML;

                        const formData = new FormData(editForm);

                        fetch(`/admin/pages/${page.id}/update`, {
                            method: 'POST',
                            body: formData
                        })
                        .then(r => r.json())
                        .then(data => {
                            if (data.success) {
                                alert('Page updated successfully!');
                                modal.style.display = 'none';
                                location.reload(); // refresh admin list
                            } else {
                                alert('Save failed: ' + (data.error || 'Unknown error'));
                            }
                        })
                        .catch(err => {
                            console.error('Save error:', err);
                            alert('Error saving page: ' + err.message);
                        });
                    };
                }
            })
            .catch(err => {
                console.error('Edit page fetch error:', err);
                alert('Error loading page: ' + err.message);
            });
    }

    // ‚îÄ‚îÄ‚îÄ Delete NPC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function deleteNPC(id, name) {
        if (!confirm(`Are you sure you want to delete "${name}"?`)) return;

        fetch(`/admin/npcs/${id}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => {
            if (response.ok) {
                alert('NPC deleted!');
                location.reload();
            } else {
                return response.json().then(err => {
                    alert('Unable to delete: ' + (err.error || 'Unknown error'));
                });
            }
        })
        .catch(err => alert('Error: ' + err));
    }

    // ‚îÄ‚îÄ‚îÄ Tab Switching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function switchTab(tab) {
      document.getElementById('tabcontent-pages').style.display = tab === 'pages' ? 'block' : 'none';
      document.getElementById('tabcontent-npcs').style.display = tab === 'npcs' ? 'block' : 'none';
      document.getElementById('tab-btn-pages').style.background = tab === 'pages' ? 'var(--cyan)' : 'rgba(0,255,255,0.1)';
      document.getElementById('tab-btn-pages').style.color = tab === 'pages' ? '#000' : 'var(--cyan)';
      document.getElementById('tab-btn-npcs').style.background = tab === 'npcs' ? 'var(--cyan)' : 'rgba(0,255,255,0.1)';
      document.getElementById('tab-btn-npcs').style.color = tab === 'npcs' ? '#000' : 'var(--cyan)';
    }

    function filterPages() {
      var term = document.getElementById('pageSearch').value.toLowerCase();
      document.querySelectorAll('#pagesTableBody tr').forEach(function(row) {
        var title = row.dataset.title || '';
        var cat = row.dataset.category || '';
        row.style.display = (title.includes(term) || cat.includes(term)) ? '' : 'none';
      });
    }

    // ‚îÄ‚îÄ‚îÄ Pages Search Filter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function filterPages() {
      const term = document.getElementById('pageSearch').value.toLowerCase();
      document.querySelectorAll('#pagesTableBody tr').forEach(row => {
        const title = row.dataset.title || '';
        const slug = row.dataset.slug || '';
        const cat = row.dataset.category || '';
        row.style.display = (title.includes(term) || slug.includes(term) || cat.includes(term)) ? '' : 'none';
      });
    }

    // ‚îÄ‚îÄ‚îÄ NPC Search Filter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function filterNPCs() {
        const searchTerm = document.getElementById('npcSearch').value.toLowerCase();
        const npcCards = document.querySelectorAll('.npc-card');
        
        npcCards.forEach(card => {
            const name = card.dataset.name;
            const location = card.dataset.location;
            const matches = name.includes(searchTerm) || location.includes(searchTerm);
            card.style.display = matches ? '' : 'none';
        });
    }

    // ‚îÄ‚îÄ‚îÄ Delete Page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function deletePage(id, title) {
        if (!confirm(`Are you sure you want to delete "${title}"?`)) return;

        fetch(`/admin/pages/${id}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => {
            if (response.ok) {
                alert('Page deleted!');
                location.reload();
            } else {
                return response.json().then(err => {
                    alert('Unable to delete: ' + (err.error || 'Server error'));
                });
            }
        })
        .catch(err => alert('Error: ' + err));
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
    <script>
<script src="/js/admin.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
