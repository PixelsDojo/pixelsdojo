<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Time-Limited Events | Pixels Dojo Wiki</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/chat-widget.css">
  <style>
    .all-posts-page {
      background: var(--dark-bg, #0f0f1a);
      color: #e0e0ff;
      min-height: 100vh;
    }

    .filters-container {
      background: rgba(0, 255, 255, 0.05);
      border: 1px solid rgba(0, 255, 255, 0.2);
      border-radius: 12px;
      padding: 1.2rem;
      margin-bottom: 2rem;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      justify-content: space-between;
    }

    .search-input {
      flex: 1;
      min-width: 220px;
      padding: 0.8rem 1.2rem;
      background: rgba(20, 20, 40, 0.8);
      border: 1px solid rgba(0, 255, 255, 0.3);
      border-radius: 8px;
      color: white;
      font-size: 1rem;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--cyan, #00ffff);
      box-shadow: 0 0 12px rgba(0, 255, 255, 0.3);
    }

    .category-filter {
      padding: 0.8rem 1.2rem;
      background: rgba(20, 20, 40, 0.8);
      border: 1px solid rgba(0, 255, 255, 0.3);
      border-radius: 8px;
      color: white;
      font-size: 1rem;
      min-width: 180px;
    }

    .category-filter option {
      background: #0f0f1a;
      color: white;
    }

    @media (max-width: 768px) {
      .filters-container {
        flex-direction: column;
      }
      .search-input, .category-filter {
        width: 100%;
      }
    }

    .all-posts-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 1.5rem;
    }

    .post-item {
      background: rgba(20, 20, 40, 0.8);
      border: 1px solid rgba(0, 255, 255, 0.2);
      border-radius: 12px;
      padding: 1.5rem;
      transition: all 0.3s ease;
      backdrop-filter: blur(6px);
      position: relative;
      overflow: hidden;
    }

    .post-item:hover {
      transform: translateY(-4px);
      border-color: var(--cyan);
      box-shadow: 0 10px 25px rgba(0, 255, 255, 0.15);
    }

    /* Expired overlay */
    .post-item.expired::before {
      content: 'EXPIRED';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-15deg);
      font-size: 4rem;
      font-weight: bold;
      color: rgba(255, 0, 0, 0.3);
      z-index: 1;
      pointer-events: none;
      text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.8);
    }

    .post-item.expired {
      opacity: 0.7;
      filter: grayscale(0.5);
    }

    /* Status badge */
    .status-badge {
      display: inline-block;
      padding: 0.3rem 0.8rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: bold;
      text-transform: uppercase;
      margin-left: 0.5rem;
    }

    .status-badge.active {
      background: rgba(0, 255, 0, 0.2);
      color: #00ff00;
      border: 1px solid #00ff00;
    }

    .status-badge.expired {
      background: rgba(255, 0, 0, 0.2);
      color: #ff5555;
      border: 1px solid #ff5555;
    }

    .expiry-info {
      font-size: 0.85rem;
      color: #ffaa00;
      margin-top: 0.5rem;
      font-weight: 500;
    }

    .post-meta {
      color: #b0b0ff;
      font-size: 0.9rem;
      margin: 0.5rem 0;
    }

    .post-snippet {
      color: #d0d0ff;
      margin-top: 1rem;
      line-height: 1.6;
    }

    h3 a {
      color: var(--cyan);
      text-decoration: none;
      transition: color 0.2s;
    }

    h3 a:hover {
      color: var(--yellow);
    }
  </style>
</head>
<body class="all-posts-page">
  <%- include('partials/header') %>

  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="/category/startup">Start Here</a></li>
      <li><a href="/category/earn">Earn $PIXEL</a></li>
      <li><a href="/category/mastery">Mastery</a></li>
      <li><a href="/npcs-map">NPCs & Map</a></li>
      <li><a href="/events">Events</a></li>
      <li><a href="/amas">AMAs</a></li>
      <li><a href="/category/community">Community</a></li>
    </ul>
  </nav>

  <div class="main-wrapper">
    <aside class="sidebar">
      <h4>Library</h4>
      <a href="/">üè† All Articles</a>
      <a href="/npcs-map">üó∫Ô∏è NPCs & Map</a>
      <a href="/events">‚ö° Events</a>
      <a href="/amas">üí¨ AMAs</a>
      <hr>
      <h5>Categories</h5>
      <a href="/category/startup">Start Here</a>
      <a href="/category/earn">Earn $PIXEL</a>
      <a href="/category/mastery">Mastery</a>
      <a href="/category/community">Community</a>
    </aside>

    <div class="main-content-area">
      <h1>‚ö° Time-Limited Events</h1>
      <p style="color: #b0b0ff; margin-bottom: 2rem;">
        Limited-time quests, competitions, and special events in Pixels Online
      </p>

      <!-- Search + Filter Bar -->
      <div class="filters-container">
        <input 
          type="text" 
          id="searchInput" 
          class="search-input" 
          placeholder="Search events by title or description..."
        >
        <select id="statusFilter" class="category-filter">
          <option value="">All Events</option>
          <option value="active">Active Only</option>
          <option value="expired">Expired Only</option>
        </select>
      </div>

      <% if (events.length === 0) { %>
        <p style="text-align: center; color: #a0a0ff; font-size: 1.2rem;">
          No events yet ‚Äî check back soon!
        </p>
      <% } else { %>
        <div class="all-posts-list" id="postsList">
          <% events.forEach(event => { 
            // Calculate if expired (day AFTER expiry in UTC-12 timezone)
            const expiryDate = new Date(event.expires_on);
            const gracePeriod = new Date(expiryDate);
            gracePeriod.setDate(gracePeriod.getDate() + 1); // Add 1 day
            gracePeriod.setHours(gracePeriod.getHours() + 12); // Add 12 hours for UTC-12
            const now = new Date();
            const isExpired = now > gracePeriod;
            const status = isExpired ? 'expired' : 'active';
            
            // Calculate days remaining
            const daysRemaining = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
          %>
            <div class="post-item <%= isExpired ? 'expired' : '' %>" 
                 data-title="<%= event.title.toLowerCase() %>"
                 data-content="<%= event.content.replace(/<[^>]*>/g, '').substring(0, 500).toLowerCase() %>"
                 data-status="<%= status %>">
              <h3>
                <a href="/pages/<%= event.slug %>"><%= event.title %></a>
                <span class="status-badge <%= status %>"><%= status %></span>
              </h3>
              <div class="post-meta">
                By <%= event.author_display_name || 'Pixels Dojo' %> 
                ¬∑ <%= new Date(event.created_at).toLocaleDateString() %>
              </div>
              <div class="expiry-info">
                <% if (isExpired) { %>
                  Expired on: <%= expiryDate.toLocaleDateString() %>
                <% } else { %>
                  <% if (daysRemaining === 0) { %>
                    ‚è∞ Expires TODAY!
                  <% } else if (daysRemaining === 1) { %>
                    ‚è∞ Expires TOMORROW!
                  <% } else if (daysRemaining <= 7) { %>
                    ‚è∞ Expires in <%= daysRemaining %> days (<%= expiryDate.toLocaleDateString() %>)
                  <% } else { %>
                    Expires: <%= expiryDate.toLocaleDateString() %>
                  <% } %>
                <% } %>
              </div>
              <p class="post-snippet">
                <%= (event.summary || event.content.replace(/<[^>]*>/g, '').substring(0, 150) + '...') %>
              </p>
            </div>
          <% }) %>
        </div>
      <% } %>
    </div>
  </div>

<%- include('partials/back-to-top') %>
  <%- include('partials/footer') %>
  <script src="/js/chat-widget.js"></script>

  <!-- Client-side filter script -->
  <script>
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const postsList = document.getElementById('postsList');

    function filterEvents() {
      const searchTerm = searchInput.value.toLowerCase().trim();
      const selectedStatus = statusFilter.value;

      const postItems = postsList.querySelectorAll('.post-item');

      postItems.forEach(item => {
        const title = item.dataset.title;
        const content = item.dataset.content;
        const status = item.dataset.status;

        const matchesSearch = 
          title.includes(searchTerm) || 
          content.includes(searchTerm);

        const matchesStatus = 
          !selectedStatus || 
          status === selectedStatus;

        item.style.display = 
          matchesSearch && matchesStatus ? '' : 'none';
      });
    }

    searchInput.addEventListener('input', filterEvents);
    statusFilter.addEventListener('change', filterEvents);
  </script>
</body>
</html>
